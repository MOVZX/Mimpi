<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mimpi - NSFW</title>
        <style>
            body {
                margin: 0;
                padding: 20px;
                font-family: "Arial", sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                color: #fff;
            }

            .container {
                max-width: 500px;
                margin: 0 auto;
                background: rgba(255, 255, 255, 0.05);
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
            }

            h1 {
                text-align: center;
                color: #00d4ff;
                text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
                margin-bottom: 30px;
            }

            h2 {
                text-align: center;
                color: #00d4ff;
                text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
                margin-bottom: 30px;
            }

            .form-group {
                margin-bottom: 20px;
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            .form-group label {
                display: block;
                margin-bottom: 0;
                color: #e0e0e0;
                font-weight: bold;
            }

            .checkbox-group {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
                padding: 5px 0;
                min-height: 24px;
            }

            .checkbox-group .checkbox-wrapper {
                display: flex;
                align-items: center;
            }

            .checkbox-group input[type="checkbox"] {
                margin: 0;
                width: 16px;
                height: 16px;
                flex-shrink: 0;
                vertical-align: middle;
            }

            .checkbox-group label {
                margin: 0;
                color: #e0e0e0;
                font-weight: bold;
                white-space: nowrap;
                line-height: 1;
                vertical-align: middle;
                display: flex;
                align-items: center;
            }

            input,
            textarea,
            select {
                width: 100%;
                padding: 10px;
                border: none;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.1);
                color: #fff;
                font-size: 16px;
                transition: all 0.3s ease;
                box-sizing: border-box;
            }

            input:focus,
            textarea:focus,
            select:focus {
                outline: none;
                background: rgba(255, 255, 254, 0.15);
                box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            }

            textarea {
                min-height: 100px;
                resize: vertical;
            }

            button {
                width: 100%;
                padding: 12px;
                background: linear-gradient(45deg, #00d4ff, #ff00ff);
                border: none;
                border-radius: 8px;
                color: #fff;
                font-size: 18px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-top: 10px;
            }

            button:disabled {
                background: rgba(255, 255, 255, 0.1);
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            button:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
            }

            img {
                max-width: 100%;
                height: auto;
                margin-top: 20px;
                border-radius: 8px;
                box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
            }

            #status {
                margin-top: 20px;
                text-align: center;
                padding: 10px;
                border-radius: 8px;
                display: none;
            }

            #error {
                margin-top: 20px;
                text-align: center;
                padding: 10px;
                border-radius: 8px;
                display: none;
                background: rgba(255, 0, 0, 0.1);
                color: #ff4444;
            }

            .success {
                background: rgba(0, 255, 0, 0.1);
                color: #00ff00;
            }

            .image-actions {
                display: none;
                margin-top: 10px;
                gap: 10px;
                justify-content: center;
            }

            .image-actions button {
                width: 100%;
                padding: 8px;
                font-size: 16px;
                background: linear-gradient(45deg, #00d4ff, #00ff00);
                margin-top: 0;
            }

            .image-actions button.preview {
                background: linear-gradient(45deg, #ff00ff, #00d4ff);
            }

            /* Custom styles for the expandable section */
            details {
                margin-bottom: 20px;
            }

            summary {
                cursor: pointer;
                padding: 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                color: #00d4ff;
                font-weight: bold;
                transition: all 0.3s ease;
            }

            summary:hover {
                background: rgba(255, 255, 255, 0.15);
                box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            }

            details[open] summary {
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }

            details > div {
                padding: 10px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 0 0 8px 8px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Mimpi - NSFW</h1>
            <div class="form-group">
                <label for="prompt">
                    Deskripsi Gambar (dalam bahasa Inggris)
                    <span style="color: #aaa; font-weight: normal"></span>
                </label>
                <textarea id="prompt" required rows="13">
1girl, (solo:1.6), beautiful 35 y.o hotwife, kneeling, looking up, eyes closed, long hair, tongue out, anticipation, pov, realistic natural teeth, detailed skin texture, goosebumps, bedroom, cinematic, highly detailed, best quality, intricate details, (photorealistic:1.4), medium close shot,  (fisheye lens:1.2), (wears black casual outfit, with bra and panties:1.1), average medium breasts, (candid photograph), natural white light, muted color</textarea
                >
            </div>
            <div class="checkbox-group">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="useDynamicPrompt" />
                </div>
                <label for="useDynamicPrompt">Gunakan Prompt Generator</label>
            </div>
            <!-- Expandable "Opsi Tingkat Lanjut" Section -->
            <details>
                <summary>Opsi Tingkat Lanjut</summary>
                <div>
                    <div class="form-group">
                        <label for="imageMode">Mode Gambar</label>
                        <select id="imageMode">
                            <option value="portrait" selected>Portrait (896x1152)</option>
                            <option value="landscape">Landscape (1152x896)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="steps">Steps <span style="color: #aaa; font-weight: normal">(1-100)</span></label>
                        <input type="number" id="steps" min="1" max="100" value="35" required />
                    </div>
                    <div class="form-group">
                        <label for="cfg"> CFG <span style="color: #aaa; font-weight: normal">(1-10)</span> </label>
                        <input type="number" id="cfg" min="1" max="10" step="0.5" value="3.5" required />
                    </div>
                    <div class="form-group">
                        <label for="seed">Seed <span style="color: #aaa; font-weight: normal">(angka)</span></label>
                        <input type="text" id="seed" placeholder="" value="-1" />
                    </div>
                    <!-- Dynamically populated dropdowns will be inserted here by populateDropdowns() -->
                </div>
            </details>
            <button onclick="generateImage()">Buat Gambar</button>
            <p id="status"></p>
            <p id="error"></p>
            <img id="outputImage" src="" alt="" style="display: none" />
            <div class="image-actions" id="imageActions">
                <button class="preview" onclick="previewImage()">Preview</button>
            </div>
        </div>

        <script>
            const COMFYUI_URL = "http://192.168.8.3:8188";
            let currentSeedNum = 0;

            const workflow = {
                4: {
                    inputs: {
                        ckpt_name: "SDXL/lustimix_.safetensors",
                    },
                    class_type: "CheckpointLoaderSimple",
                    _meta: {
                        title: "Checkpoint",
                    },
                },
                47: {
                    inputs: {
                        samples: ["160", 0],
                        vae: ["4", 2],
                    },
                    class_type: "VAEDecode",
                    _meta: {
                        title: "VAE Decode",
                    },
                },
                76: {
                    inputs: {
                        stop_at_clip_layer: -2,
                        clip: ["84", 1],
                    },
                    class_type: "CLIPSetLastLayer",
                    _meta: {
                        title: "CLIP Skip",
                    },
                },
                84: {
                    inputs: {
                        PowerLoraLoaderHeaderWidget: {
                            type: "PowerLoraLoaderHeaderWidget",
                        },
                        lora_1: {
                            on: true,
                            lora: "SDXL/add-detail-xl.safetensors",
                            strength: 0.25,
                        },
                        lora_2: {
                            on: true,
                            lora: "SDXL_1.0/Breast Slider - Pony_alpha1.0_rank4_noxattn_last.safetensors",
                            strength: 0.9,
                        },
                        "âž• Add Lora": "",
                        model: ["4", 0],
                        clip: ["4", 1],
                    },
                    class_type: "Power Lora Loader (rgthree)",
                    _meta: {
                        title: "LoRA",
                    },
                },
                103: {
                    inputs: {
                        text: "(penis:1.6), (male:1.6), (man:1.6), (men:1.6), gore, horror, text, watermark, low quality, medium quality, blurry, deformed, mutated, anime, toon, render, 3d, illustration, bad eyes, bad hands, bad fingers, asian, chinese, japanese, smiling, (tanned skin:1.4)",
                        clip: ["76", 0],
                    },
                    class_type: "CLIPTextEncode",
                    _meta: {
                        title: "Negative Prompt",
                    },
                },
                105: {
                    inputs: {
                        seed: 0,
                        steps: 35,
                        cfg: 3.5,
                        sampler_name: "dpmpp_2m",
                        scheduler: "karras",
                        denoise: 1,
                        model: ["193", 0],
                        positive: ["178:2", 0],
                        negative: ["103", 0],
                        latent_image: ["152", 0],
                    },
                    class_type: "KSampler",
                    _meta: {
                        title: "KSampler",
                    },
                },
                106: {
                    inputs: {
                        object_to_patch: "diffusion_model",
                        residual_diff_threshold: 0.12500000000000003,
                        start: 0,
                        end: 1,
                        max_consecutive_cache_hits: -1,
                        model: ["84", 0],
                    },
                    class_type: "ApplyFBCacheOnModel",
                    _meta: {
                        title: "Cache",
                    },
                },
                152: {
                    inputs: {
                        resolution: "896x1152 (0.78)",
                        batch_size: 1,
                        width_override: 0,
                        height_override: 0,
                    },
                    class_type: "SDXLEmptyLatentSizePicker+",
                    _meta: {
                        title: "Image Size",
                    },
                },
                160: {
                    inputs: {
                        aggressive: true,
                        latent: ["105", 0],
                    },
                    class_type: "FreeMemoryLatent",
                    _meta: {
                        title: "GC",
                    },
                },
                164: {
                    inputs: {
                        clip_name1: "ViT-L-14-REG-TE-only-balanced-HF-format-ckpt12.safetensors",
                        clip_name2: "clip_g.safetensors",
                        type: "sdxl",
                        device: "default",
                    },
                    class_type: "DualCLIPLoader",
                    _meta: {
                        title: "Dual CLIP Loader",
                    },
                },
                171: {
                    inputs: {
                        theme: "ðŸŽ² Dynamic Random",
                        complexity: "complex",
                        randomize: "enable",
                        debug_mode: "off",
                        seed: 0,
                        custom_subject:
                            "1girl, (solo:1.6), beautiful 35 y.o hotwife, kneeling, looking up, eyes closed, long hair, tongue out, anticipation, pov, realistic natural teeth, detailed skin texture, goosebumps, bedroom, cinematic, highly detailed, best quality, intricate details, (photorealistic:1.4), medium close shot,  (fisheye lens:1.2), (wears black casual outfit, with bra and panties:1.1), average medium breasts, (candid photograph), natural white light, muted color",
                        custom_location: "",
                        include_environment: "yes",
                        include_style: "yes",
                        include_effects: "yes",
                    },
                    class_type: "IsulionMegaPromptV3",
                    _meta: {
                        title: "Prompt Generator",
                    },
                },
                193: {
                    inputs: {
                        mode: "default",
                        backend: "inductor",
                        fullgraph: false,
                        dynamic: false,
                        model: ["106", 0],
                    },
                    class_type: "CompileModel",
                    _meta: {
                        title: "Compile",
                    },
                },
                217: {
                    inputs: {
                        filename_prefix: "",
                        images: ["47", 0],
                    },
                    class_type: "SaveImage",
                    _meta: {
                        title: "Save Image",
                    },
                },
                "178:0": {
                    inputs: {
                        text: "1girl, (solo:1.6), beautiful 35 y.o hotwife, kneeling, looking up, eyes closed, long hair, tongue out, anticipation, pov, realistic natural teeth, detailed skin texture, goosebumps, bedroom, cinematic, highly detailed, best quality, intricate details, (photorealistic:1.4), medium close shot,  (fisheye lens:1.2), (wears black casual outfit, with bra and panties:1.1), average medium breasts, (candid photograph), natural white light, muted color",
                    },
                    class_type: "Text Multiline",
                    _meta: {
                        title: "Positive Prompt",
                    },
                },
                "178:1": {
                    inputs: {
                        boolean: false,
                        on_true: ["171", 0],
                        on_false: ["178:0", 0],
                    },
                    class_type: "Switch any [Crystools]",
                    _meta: {
                        title: "ðŸª› Switch any",
                    },
                },
                "178:2": {
                    inputs: {
                        text: ["178:1", 0],
                        clip: ["76", 0],
                    },
                    class_type: "CLIPTextEncode",
                    _meta: {
                        title: "Positive Prompt",
                    },
                },
            };

            // Clear the image and actions on page reload
            window.onload = function () {
                const outputImage = document.getElementById("outputImage");
                const imageActions = document.getElementById("imageActions");
                const status = document.getElementById("status");

                outputImage.src = "";
                outputImage.style.display = "none";
                imageActions.style.display = "none";
                status.style.display = "none";
                status.className = "";
                status.textContent = "";
            };

            // Static list of ckpt_name options
            function fetchCheckpointOptions() {
                const baseCheckpoints = [
                    "---- Illustrious ----",
                    "Illustrious/cyberillustrious_v30.safetensors",
                    "Illustrious/novaRealityXL_illustriousV20.safetensors",
                    "Illustrious/realismIllustriousBy_v30FP16.safetensors",
                    "Illustrious/redcraftCADSUpdatedMar11_illust3relustion.safetensors",
                    "Illustrious/rillusmRealistic_v20.safetensors",
                    "---- Pony ----",
                    "Pony/3xthreat2kModelThatUsesPONY_v10.safetensors",
                    "Pony/babesByStableYogi_ponyV4VAEFix.safetensors",
                    "Pony/cyberrealisticPony_v85.safetensors",
                    "Pony/fasercore_v30PonyFP16.safetensors",
                    "Pony/iniverseMixSFWNSFW_ponyRealGuofengV50C.safetensors",
                    "Pony/ponyDiffusionV6XL.safetensors",
                    "Pony/pornyPonyByStable_v20FP16.safetensors",
                    "Pony/realDream_sdxlPony15.safetensors",
                    "Pony/realismByStableYogi_v40FP16.safetensors",
                    "Pony/uberRealisticPornMergePonyxl_ponyxlHybridV1.safetensors",
                    "---- SDXL ----",
                    "SDXL/acornIsBoningXL_xlV2.safetensors",
                    "SDXL/agxl_V2.safetensors",
                    "SDXL/animaPencilXL_v500.safetensors",
                    "SDXL/babesByStableYogi_v4XLFP16.safetensors",
                    "SDXL/biglovexl2.wBWt.safetensors",
                    "SDXL/biglust16.kst6.safetensors",
                    "SDXL/boomerArtModelBAM_bamV2.safetensors",
                    "SDXL/clarityXL_v20.safetensors",
                    "SDXL/cyberrealisticXL_v5.safetensors",
                    "SDXL/epicrealismXL_vxvAnewstoryRealism.safetensors",
                    "SDXL/fasercore_xlV1.safetensors",
                    "SDXL/jibMixRealisticXL_v160Aphrodite.safetensors",
                    "SDXL/juggernautXL_juggXIByRundiffusion.safetensors",
                    "SDXL/leosamsHelloworldXL_helloworldXL70.safetensors",
                    "SDXL/lustifySDXLNSFW_endgame.safetensors",
                    "SDXL/lustifySDXLNSFW_oltONELASTTIME.safetensors",
                    "SDXL/lustimix_.safetensors",
                    "SDXL/lustimix_big.safetensors",
                    "SDXL/msSDXLRealV3_v3.safetensors",
                    "SDXL/novaRealityXL_v70.safetensors",
                    "SDXL/omnigenxlNSFWSFW_v10.safetensors",
                    "SDXL/perfectionRealisticILXL_v10.safetensors",
                    "SDXL/polyhedronSDXL_v3.safetensors",
                    "SDXL/pornmaster_proSDXLV3VAE.safetensors",
                    "SDXL/realismByStableYogi_v5XLFP16.safetensors",
                    "SDXL/realismEngineSDXL_v30VAE.safetensors",
                    "SDXL/realisticLustXL_v05.safetensors",
                    "SDXL/realisticStockPhoto_v20.safetensors",
                    "SDXL/realvisxlV50_v50Bakedvae.safetensors",
                    "SDXL/sd_xl_base_1.0_0.9vae.safetensors",
                    "SDXL/sd_xl_refiner_1.0.safetensors",
                    "SDXL/sdXL_v10VAEFix.safetensors",
                    "SDXL/sdxlPhotorealisticMix_v10.safetensors",
                    "SDXL/sdxxxl_v30.safetensors",
                    "SDXL/stoiqoNewrealityFLUXSD35_XLPRO.safetensors",
                ];
                return baseCheckpoints.map((ckpt) => `${ckpt}`);
            }

            // Static list of sampler options
            function fetchSamplerOptions() {
                return [
                    "euler",
                    "euler_ancestral",
                    "dpmpp_sde",
                    "dpmpp_2m",
                    "dpmpp_2m_sde",
                    "dpmpp_3m_sde",
                    "res_multistep",
                ];
            }

            // Static list of scheduler options
            function fetchSchedulerOptions() {
                return ["normal", "karras", "exponential", "sgm_uniform", "simple", "beta"];
            }

            // Populate checkpoint, sampler, and scheduler select elements
            function populateDropdowns() {
                const container = document.querySelector(".container");
                const detailsContent = container.querySelector("details > div"); // Target the div inside details

                // Check if checkpointFormGroup already exists
                let checkpointFormGroup = document.getElementById("checkpointFormGroup");
                if (!checkpointFormGroup) {
                    const checkpointOptions = fetchCheckpointOptions();
                    checkpointFormGroup = document.createElement("div");
                    checkpointFormGroup.id = "checkpointFormGroup";
                    checkpointFormGroup.className = "form-group";

                    const checkpointLabel = document.createElement("label");
                    checkpointLabel.htmlFor = "checkpoint";
                    checkpointLabel.textContent = "Checkpoint Model";

                    const checkpointSelect = document.createElement("select");
                    checkpointSelect.id = "checkpoint";
                    checkpointSelect.name = "checkpoint";

                    checkpointOptions.forEach((option) => {
                        const optionElement = document.createElement("option");
                        // Replace either "SDXL/" or "Pony/" with an empty string
                        const displayName = option.replace(/^(SDXL\/|Pony\/|Illustrious\/)/, "");
                        optionElement.value = option;
                        optionElement.textContent = displayName;
                        if (option === "SDXL/lustimix_.safetensors") optionElement.selected = true; // Updated default
                        checkpointSelect.appendChild(optionElement);
                    });

                    checkpointFormGroup.appendChild(checkpointLabel);
                    checkpointFormGroup.appendChild(checkpointSelect);
                    detailsContent.insertBefore(checkpointFormGroup, detailsContent.firstChild); // Insert at the top
                }

                // Check if samplerFormGroup already exists
                let samplerFormGroup = document.getElementById("samplerFormGroup");
                if (!samplerFormGroup) {
                    const samplerOptions = fetchSamplerOptions();
                    samplerFormGroup = document.createElement("div");
                    samplerFormGroup.id = "samplerFormGroup";
                    samplerFormGroup.className = "form-group";

                    const samplerLabel = document.createElement("label");
                    samplerLabel.htmlFor = "sampler";
                    samplerLabel.textContent = "Sampler";

                    const samplerSelect = document.createElement("select");
                    samplerSelect.id = "sampler";
                    samplerSelect.name = "sampler";

                    samplerOptions.forEach((option) => {
                        const optionElement = document.createElement("option");
                        optionElement.value = option;
                        optionElement.textContent = option;
                        if (option === "dpmpp_2m") optionElement.selected = true;
                        samplerSelect.appendChild(optionElement);
                    });

                    samplerFormGroup.appendChild(samplerLabel);
                    samplerFormGroup.appendChild(samplerSelect);
                    detailsContent.appendChild(samplerFormGroup); // Append after other inputs
                }

                // Check if schedulerFormGroup already exists
                let schedulerFormGroup = document.getElementById("schedulerFormGroup");
                if (!schedulerFormGroup) {
                    const schedulerOptions = fetchSchedulerOptions();
                    schedulerFormGroup = document.createElement("div");
                    schedulerFormGroup.id = "schedulerFormGroup";
                    schedulerFormGroup.className = "form-group";

                    const schedulerLabel = document.createElement("label");
                    schedulerLabel.htmlFor = "scheduler";
                    schedulerLabel.textContent = "Scheduler";

                    const schedulerSelect = document.createElement("select");
                    schedulerSelect.id = "scheduler";
                    schedulerSelect.name = "scheduler";

                    schedulerOptions.forEach((option) => {
                        const optionElement = document.createElement("option");
                        optionElement.value = option;
                        optionElement.textContent = option;
                        if (option === "karras") optionElement.selected = true;
                        schedulerSelect.appendChild(optionElement);
                    });

                    schedulerFormGroup.appendChild(schedulerLabel);
                    schedulerFormGroup.appendChild(schedulerSelect);
                    detailsContent.appendChild(schedulerFormGroup); // Append after sampler
                }
            }

            // Call populateDropdowns when the DOM is ready
            document.addEventListener("DOMContentLoaded", () => {
                populateDropdowns();

                // Add event listeners for dropdown changes
                const checkpointSelect = document.getElementById("checkpoint");
                if (checkpointSelect) {
                    checkpointSelect.addEventListener("change", () => {
                        workflow["4"]["inputs"]["ckpt_name"] = checkpointSelect.value;
                        console.log("Checkpoint updated to:", checkpointSelect.value);
                    });
                }

                const samplerSelect = document.getElementById("sampler");
                if (samplerSelect) {
                    samplerSelect.addEventListener("change", () => {
                        workflow["105"]["inputs"]["sampler_name"] = samplerSelect.value; // Updated node ID
                        console.log("Sampler updated to:", samplerSelect.value);
                    });
                }

                const schedulerSelect = document.getElementById("scheduler");
                if (schedulerSelect) {
                    schedulerSelect.addEventListener("change", () => {
                        workflow["105"]["inputs"]["scheduler"] = schedulerSelect.value; // Updated node ID
                        console.log("Scheduler updated to:", schedulerSelect.value);
                    });
                }
            });

            async function generateImage() {
                const promptInput = document.getElementById("prompt").value;
                const stepsInput = document.getElementById("steps").value;
                const cfgInput = document.getElementById("cfg").value;
                const imageMode = document.getElementById("imageMode").value;
                const seedInput = document.getElementById("seed").value;
                const useDynamicPrompt = document.getElementById("useDynamicPrompt").checked;
                const status = document.getElementById("status");
                const error = document.getElementById("error");
                const button = document.querySelector("button");
                const outputImage = document.getElementById("outputImage");
                const imageActions = document.getElementById("imageActions");

                if (!promptInput) {
                    showError(error, "Deskripsi gambar tidak boleh kosong!");
                    return;
                }

                // Fallback: Ensure dropdowns are populated
                if (!document.getElementById("checkpoint")) {
                    populateDropdowns();
                }

                showStatus(status, "Membuat gambar...");
                error.style.display = "none";
                outputImage.style.display = "none";
                imageActions.style.display = "none";
                button.disabled = true;

                try {
                    const steps = parseInt(stepsInput);
                    const cfg = parseFloat(cfgInput);
                    if (isNaN(steps) || steps < 1 || steps > 100) {
                        throw new Error("Steps harus berupa angka antara 1 dan 100!");
                    }
                    if (isNaN(cfg) || cfg < 1 || cfg > 30) {
                        throw new Error("CFG harus berupa angka antara 1 dan 30!");
                    }

                    const checkpointSelect = document.getElementById("checkpoint");
                    const samplerSelect = document.getElementById("sampler");
                    const schedulerSelect = document.getElementById("scheduler");
                    if (checkpointSelect && samplerSelect && schedulerSelect) {
                        workflow["4"]["inputs"]["ckpt_name"] = checkpointSelect.value;
                        workflow["178:0"]["inputs"]["text"] = promptInput; // Updated node ID
                        workflow["171"]["inputs"]["custom_subject"] = promptInput; // Updated node ID
                        workflow["105"]["inputs"]["steps"] = steps; // Updated node ID
                        workflow["105"]["inputs"]["cfg"] = cfg; // Updated node ID
                        workflow["105"]["inputs"]["sampler_name"] = samplerSelect.value; // Updated node ID
                        workflow["105"]["inputs"]["scheduler"] = schedulerSelect.value; // Updated node ID
                        // Note: Dynamic prompt is disabled in the workflow (boolean: false), but keeping the toggle for consistency
                        workflow["178:1"]["inputs"]["boolean"] = useDynamicPrompt; // Updated node ID
                    } else {
                        throw new Error("Checkpoint, Sampler, or Scheduler dropdown not found!");
                    }

                    const MAX_SEED = BigInt("18446744073709551615");
                    if (!seedInput || isNaN(seedInput) || seedInput === "-1") {
                        const randomValue =
                            BigInt(Math.floor(Math.random() * Number.MAX_SAFE_INTEGER)) *
                            BigInt(Math.floor(Math.random() * Number.MAX_SAFE_INTEGER));
                        const seed = randomValue % (MAX_SEED + BigInt(1));
                        currentSeedNum = seed;
                        workflow["105"]["inputs"]["seed"] = Number(seed); // Updated node ID
                        workflow["171"]["inputs"]["seed"] = Number(seed); // Updated node ID
                    } else {
                        const seedNum = BigInt(seedInput);
                        if (seedNum < BigInt(0) || seedNum > MAX_SEED) {
                            throw new Error(`Seed harus antara 0 dan ${MAX_SEED}!`);
                        }
                        currentSeedNum = seedNum;
                        workflow["105"]["inputs"]["seed"] = Number(seedNum); // Updated node ID
                        workflow["171"]["inputs"]["seed"] = Number(seedNum); // Updated node ID
                    }

                    if (imageMode === "portrait") {
                        workflow["152"]["inputs"]["resolution"] = "896x1152 (0.78)"; // Updated node ID
                    } else if (imageMode === "landscape") {
                        workflow["152"]["inputs"]["resolution"] = "1152x896 (1.29)"; // Updated node ID
                    }

                    // Update filename_prefix to match the workflow's hardcoded value, with seed appended
                    const formatDateISO = (date) => {
                        const isoString = date.toISOString();
                        const formattedDate = isoString.split("T")[0];
                        return formattedDate;
                    };

                    const currentDate = new Date();
                    const formattedDate = formatDateISO(currentDate);

                    workflow["217"]["inputs"]["filename_prefix"] = `webui-rated-r/${formattedDate}/${currentSeedNum}`; // Updated node ID

                    console.log("Generating with:", {
                        checkpoint: workflow["4"]["inputs"]["ckpt_name"],
                        sampler: workflow["105"]["inputs"]["sampler_name"], // Updated node ID
                        scheduler: workflow["105"]["inputs"]["scheduler"], // Updated node ID
                        seed: workflow["105"]["inputs"]["seed"], // Updated node ID
                        useDynamicPrompt: useDynamicPrompt,
                    });

                    const response = await fetch(`${COMFYUI_URL}/prompt`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt: workflow, client_id: "webapp" }),
                    });

                    if (!response.ok) throw new Error("Gagal terhubung ke server ComfyUI. Pastikan server berjalan!");

                    const { prompt_id } = await response.json();

                    let imageUrl = null;
                    let attempts = 0;
                    const maxAttempts = 30; // Maximum 30 seconds (1 second per attempt)
                    while (!imageUrl && attempts < maxAttempts) {
                        await new Promise((resolve) => setTimeout(resolve, 1000));
                        const historyResponse = await fetch(`${COMFYUI_URL}/history/${prompt_id}`);
                        const history = await historyResponse.json();
                        console.log("History response:", history); // Debug log

                        if (history[prompt_id] && history[prompt_id].outputs && history[prompt_id].outputs["217"]) {
                            const images = history[prompt_id].outputs["217"].images;
                            if (images && Array.isArray(images) && images.length > 0) {
                                const imageData = images[0];
                                if (
                                    imageData &&
                                    typeof imageData === "object" &&
                                    imageData.filename &&
                                    imageData.subfolder !== undefined &&
                                    imageData.type
                                ) {
                                    imageUrl = `${COMFYUI_URL}/view?filename=${imageData.filename}&subfolder=${imageData.subfolder}&type=${imageData.type}`;
                                } else {
                                    console.log("Image data is missing required properties:", imageData);
                                }
                            } else {
                                console.log("No images found in output 217 yet:", images);
                            }
                        } else {
                            console.log("Prompt ID or output 217 not found in history:", history[prompt_id]?.outputs);
                        }
                        attempts++;
                    }

                    if (!imageUrl) {
                        throw new Error(
                            "Gagal mengambil gambar setelah mencoba selama 30 detik. Periksa server ComfyUI atau konfigurasi workflow."
                        );
                    }

                    outputImage.src = imageUrl;
                    outputImage.style.display = "block";
                    imageActions.style.display = "flex";
                    const successMessage = `Gambar berhasil dibuat! Seed: ${currentSeedNum}`;
                    showStatus(status, successMessage, "success");

                    localStorage.setItem("lastGeneratedImage", imageUrl);
                    localStorage.setItem("lastStatus", successMessage);
                } catch (err) {
                    let errorMessage = err.message;
                    if (errorMessage.includes("fetch")) {
                        errorMessage = "Tidak dapat terhubung ke server. Pastikan ComfyUI berjalan!";
                    } else if (errorMessage.includes("Seed")) {
                        errorMessage = `Masukkan seed yang valid (angka antara 0 dan ${MAX_SEED})!`;
                    }
                    showError(error, errorMessage);
                } finally {
                    button.disabled = false;
                }
            }

            function previewImage() {
                const outputImage = document.getElementById("outputImage");
                const imageUrl = outputImage.src;
                window.open(imageUrl, "_blank");
            }

            function showStatus(statusElement, message, type = "") {
                statusElement.textContent = message;
                statusElement.style.display = "block";
                statusElement.className = type;
                if (type !== "success") {
                    setTimeout(() => {
                        if (statusElement.className !== "success") {
                            statusElement.style.display = "none";
                        }
                    }, 5000);
                }
            }

            function showError(errorElement, message) {
                errorElement.textContent = message;
                errorElement.style.display = "block";
                setTimeout(() => (errorElement.style.display = "none"), 5000);
            }
        </script>
    </body>
</html>
